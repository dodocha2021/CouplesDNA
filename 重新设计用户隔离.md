最终版项目改造计划：实现全站报告与配置功能的用户隔离

  第一部分：目标与原则

   * 核心目标: 本计划旨在将您现有的用户隔离实践（例如在 Supabase Storage 中按 user_id 存放
     chatlog）扩展到项目的每一个层面，包括数据库、后端API、n8n工作流和前端UI。最终实现“报告生成”和“Prompt配置”等所有相关功能的端到端用户数据隔离。
   * 核心原则: 以 user_id (来源于 profiles 表的 id) 作为数据所有权的唯一标识。在项目的每一个环节中，都使用 user_id 进行严格的数据筛选和验证。

  ---

  第二部分：数据库结构升级 (Database Schema Upgrade)

  此步骤是整个计划的基石，它将为您的文件存储提供元数据索引，并为其他功能提供数据层支持。

  行动：
  请在 Supabase 中，为以下所有 8 个表 添加一个名为 user_id 的新列。

   1. `chat-logs`: 为您存储在 Supabase Storage 中的聊天日志文件提供元数据索引，使其可以被高效查询，而无需遍历文件列表。
   2. `chat_sessions`: 关联整个聊天会话。
   3. `chat_messages`: 关联每一条具体消息。
   4. `n8n_chat_histories`: 关联报告生成过程的历史记录。
   5. `workflow_progress`: 关联异步任务（如报告生成）的进度。
   6. `n8n_workflow_sessions`: 关联管理员后台追踪的工作流会话。
   7. `prompts_settings`: 关联用户自定义的 Prompt 设置。
   8. `prompts_config`: 关联用户自定义的 Prompt 配置。

  关键技术建议：
   * 数据类型: 将 user_id 列的类型设置为 UUID。
   * 数据完整性: 将该列设置为一个外键 (Foreign Key)，使其指向 public.profiles 表的 id 列。

  ---

  第三部分：后端 API 层改造 (Backend API Layer)

  步骤 3.1: 创建用户身份认证辅助函数
   * 文件: lib/supabase.js (或新建 lib/auth.js)
   * 行动: 添加一个标准函数，用于在 API 路由中安全地获取当前请求的用户信息。
   1     export const getUserFromRequest = async (req) => {
   2       const { user, error } = await supabase.auth.api.getUserByCookie(req);
   3       if (error || !user) return null;
   4       return user;
   5     };

  步骤 3.2: 全面加固所有相关 API
   * 涉及文件:
       * pages/api/upload.js (处理文件上传)
       * pages/api/generate-Finalreport.js
       * pages/api/get-prompts.js, pages/api/save-prompts.js, pages/api/clear-prompts.js
       * pages/api/get-session-history.js, pages/api/get-workflow-progress.js
       * 以及任何其他处理上述8个表数据的API。
   * 行动: 对上述所有文件应用统一的安全模式：
       1. 在处理函数的开头，调用 const user = await getUserFromRequest(req); 获取用户。
       2. 检查 if (!user)，如果用户不存在，则立即返回 res.status(401).json({ error: 'Unauthorized' });。
       3. 在后续所有与数据库的交互中，无论是 select, insert, update 还是 delete，都必须加入 .eq('user_id', user.id) 作为查询条件。

  ---

  第四部分：n8n 工作流改造 (n8n Workflow Modification)

  将您现有的文件隔离实践延伸到报告生成的异步流程中。

  步骤 4.1: 后端触发 n8n 时传递 `user_id`
   * 文件: pages/api/generate-Finalreport.js (或任何触发 n8n 的 API)
   * 行动: 在调用 n8n 的 Webhook 时，必须在发送的 JSON 数据体 (payload) 中明确包含 user_id。
   1     const n8nPayload = {
   2       user_id: user.id, // 必须传递
   3       // ...其他需要的数据
   4     };
   5     await fetch('YOUR_N8N_WEBHOOK_URL', { /* ... */ });

  步骤 4.2: 修改 n8n 工作流内部逻辑
   1. Webhook 节点: 确保工作流能从入口数据中接收 user_id。
   2. 数据库节点: 在 n8n 中任何与数据库交互的节点，都必须使用传入的 user_id ({{$json.user_id}}) 作为查询条件，以确保操作的准确性。
   3. 文件存储节点:
       * 行动: 采用与存储 chatlog 完全相同的策略来存储最终生成的报告文件。在 n8n 的文件存储节点中，使用传入的 user_id 动态构建文件路径。
       * 示例路径: final-reports/{{$json.user_id}}/report-{{$now.toMillis()}}.pdf

  ---

  第五部分：前端逻辑与 UI 改造 (Frontend Logic & UI)

  步骤 5.1: 改造所有报告与配置页面
   * 涉及页面与组件:
       * pages/test-finalreport.js, pages/report.js, pages/report/[sessionId].js
       * components/content/MyReportsContent.tsx, components/file-uploader.tsx
       * hooks/useReportGenerator.js
       * 所有与 Prompt 配置相关的前端页面和组件。
   * 统一行动:
       1. 数据获取/提交: 所有的数据交互（获取列表、获取详情、上传文件、生成报告、保存设置）都必须通过调用您在第三部分中加固过的后端 API
          来完成。前端不再直接与 Supabase 交互处理这些业务。
       2. 页面访问控制: 在动态页面（如 pages/report/[sessionId].js）中，由后端 API 负责验证数据归属。如果用户无权访问，API 应返回 404 或 403
          错误，前端页面需要优雅地处理这种情况（例如，显示“内容未找到”）。


文件级详细行动计划：全站功能用户隔离

  第一部分：数据库结构升级 (必须首先完成)

  此步骤是所有后续工作的基础。

   * 行动: 在 Supabase 中，为以下 8 个表 添加 user_id 列。
       1. chat-logs
       2. chat_sessions
       3. chat_messages
       4. n8n_chat_histories
       5. workflow_progress
       6. n8n_workflow_sessions
       7. prompts_settings
       8. prompts_config
   * 关键建议:将 user_id 列的类型设为 UUID 并将其设置为指向 profiles.id 的外键。

  ---

  第二部分：后端 API 层改造

  任务： 为所有需要用户隔离的 API 端点添加身份验证和数据筛选逻辑。

   * 文件: lib/supabase.js (或 lib/auth.js)
       * 说明: 在此文件中，创建一个名为 getUserFromRequest 的辅助函数，其功能是通过解析请求中的 cookie 来获取并返回 Supabase
         用户对象。这将是后续所有 API 安全验证的基础。

   * 文件: pages/api/upload.js
       * 说明: 修改此 API。在处理函数顶部，使用 getUserFromRequest 获取用户。在调用 Supabase Storage 的 upload 方法时，使用获取到的 user.id
         来构建文件存储路径（例如 /{user.id}/filename）。在向 chat-logs 表插入元数据时，必须将 user_id 字段一同存入。

   * 文件: pages/api/generate-Finalreport.js
       * 说明: 修改此 API。使用 getUserFromRequest 实现用户身份验证。从 prompts_config 读取数据时，必须加入 user_id 作为查询条件。在触发 n8n
         工作流时，必须将 user.id 包含在发送到 webhook 的 JSON 数据中。

   * 文件: pages/api/get-prompts.js, pages/api/save-prompts.js, pages/api/clear-prompts.js
       * 说明: 修改这三个 API。在每个 API 的处理函数顶部都使用 getUserFromRequest 进行用户验证。所有针对 prompts_settings 和 prompts_config
         表的数据库操作，都必须加入 user_id 作为查询条件。

   * 文件: pages/api/get-session-history.js, pages/api/get-workflow-progress.js
       * 说明: 修改这两个 API。使用 getUserFromRequest 进行用户验证。所有针对 workflow_progress 或 n8n_chat_histories 表的数据库查询，都必须加入
         user_id 作为过滤条件。

  ---

  第三部分：n8n 工作流改造

  任务： 使异步工作流能够识别并处理特定用户的数据。

   * 节点: Webhook 触发节点
       * 说明: 配置此节点，确保它能从触发器发送的 JSON 数据中正确解析出 user_id 字段。

   * 节点: 数据库节点 (Supabase/Postgres)
       * 说明: 修改工作流中所有与数据库交互的节点。在你的 SQL 查询语句中，必须使用从 Webhook 节点获取的 user_id 作为 WHERE
         子句的一部分，以确保只操作属于该用户的数据。

   * 节点: 文件存储节点 (File Storage)
       * 说明: 修改用于保存最终报告的节点。采用与存储 chatlog 相同的策略，使用从 Webhook 节点获取的 user_id 来动态构建文件存储的目标路径，例如
         final-reports/{user_id}/。

  ---

  第四部分：前端 UI 与逻辑改造

  任务： 将前端的所有数据交互从直接调用 Supabase 切换为调用加固后的后端 API。

   * 文件: hooks/useReportGenerator.js
       * 说明: 修改此 hook 中的 fetch 调用，确保它指向的是加固后的后端 API（例如 /api/generate-Finalreport.js），而不是直接与 Supabase 交互。

   * 文件: components/file-uploader.tsx
       * 说明: 修改此组件的文件上传逻辑。确保它调用的是加固后的 /api/upload.js 后端接口来处理文件上传，而不是在客户端直接操作 Supabase Storage。

   * 文件: components/content/MyReportsContent.tsx
       * 说明: 修改此组件的数据获取逻辑。它应该调用一个加固后的后端 API（例如 /api/reports）来获取报告列表，然后直接渲染返回的用户专属数据。

   * 文件: pages/report/[sessionId].js
       * 说明: 修改此页面的数据获取逻辑（无论是在 getServerSideProps 还是 useEffect 中）。它必须通过调用一个加固后的后端 API
         来获取特定报告的数据。后端 API 会负责验证该 sessionId 是否属于当前登录用户。

   * 文件: pages/test-finalreport.js
       * 说明: 修改此页面的所有数据交互逻辑。无论是获取历史记录还是触发新的报告生成，都必须通过调用对应的、已经加固过的后端 API 来完成。

   * 组件: 所有 Prompt 管理相关的组件
       * 说明: 定位到所有用于管理 Prompt 配置的前端组件。修改它们的逻辑，确保所有的数据读写操作都通过调用加固后的 get-prompts 和 save-prompts
         等后端 API 来进行。

---

## 实施 Todo List

### 数据库层
- [x] 1. 数据库结构升级：为8个表添加user_id列

### 后端API层  
- [x] 2. 创建用户身份认证辅助函数 getUserFromRequest
- [x] 3. 改造 pages/api/upload.js 添加用户验证和隔离
- [x] 4. 改造 pages/api/generate-Finalreport.js 添加用户验证
- [x] 5. 改造 Prompt 相关API (get-prompts.js, save-prompts.js, clear-prompts.js)
- [x] 6. 改造历史记录API (get-session-history.js, get-workflow-progress.js)

### n8n工作流层
- [ ] 7. n8n工作流改造 - Webhook节点配置
- [ ] 8. n8n工作流改造 - 数据库节点修改
- [ ] 9. n8n工作流改造 - 文件存储节点修改
- [ ] 10. 测试n8n工作流完整性

### 前端UI层
- [ ] 11. 改造 hooks/useReportGenerator.js
- [ ] 12. 改造 components/file-uploader.tsx
- [ ] 13. 改造 components/content/MyReportsContent.tsx
- [ ] 14. 改造 pages/report/[sessionId].js
- [ ] 15. 改造 pages/test-finalreport.js
- [ ] 16. 改造所有Prompt管理相关组件

### 最终测试
- [ ] 17. 全面测试用户隔离功能